# Azure Container Apps deployment configuration
name: reddytalk-api
location: eastus
resourceGroup: reddytalk-rg

containerApp:
  name: reddytalk-api
  properties:
    managedEnvironmentId: /subscriptions/{subscription-id}/resourceGroups/reddytalk-rg/providers/Microsoft.App/managedEnvironments/reddytalk-env
    configuration:
      ingress:
        external: true
        targetPort: 8080
        allowInsecure: false
        traffic:
          - weight: 100
            latestRevision: true
      secrets:
        - name: azure-speech-key
          value: "{azure-speech-key}"
        - name: azure-openai-key
          value: "{azure-openai-key}"
        - name: azure-openai-endpoint
          value: "{azure-openai-endpoint}"
        - name: azure-communication-connection-string
          value: "{azure-communication-connection-string}"
    template:
      containers:
        - name: reddytalk-api
          image: reddytalkacr.azurecr.io/reddytalk-api:latest
          resources:
            cpu: "1.0"
            memory: "2Gi"
          env:
            - name: NODE_ENV
              value: "production"
            - name: PORT
              value: "8080"
            - name: AZURE_SPEECH_KEY
              secretRef: azure-speech-key
            - name: AZURE_SPEECH_REGION
              value: "eastus"
            - name: AZURE_SPEECH_VOICE
              value: "en-US-JennyNeural"
            - name: AZURE_OPENAI_API_KEY
              secretRef: azure-openai-key
            - name: AZURE_OPENAI_ENDPOINT
              secretRef: azure-openai-endpoint
            - name: AZURE_OPENAI_DEPLOYMENT
              value: "gpt-4-turbo"
            - name: AZURE_OPENAI_API_VERSION
              value: "2024-02-01"
            - name: AZURE_COMMUNICATION_CONNECTION_STRING
              secretRef: azure-communication-connection-string
      scale:
        minReplicas: 1
        maxReplicas: 10
        rules:
          - name: http-scaler
            http:
              metadata:
                concurrentRequests: "30"